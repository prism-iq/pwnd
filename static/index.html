<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWND.ICU - Epstein Investigation</title>
    <style>
        :root {
            --bg: #0d0d0d;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --bg-input: #222;
            --bg-hover: #2a2a2a;
            --border: #2a2a2a;
            --border-light: #333;
            --text: #f0f0f0;
            --text-secondary: #999;
            --text-dim: #666;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.15);
            --green: #10b981;
            --green-glow: rgba(16, 185, 129, 0.15);
            --orange: #f59e0b;
            --red: #ef4444;
            --purple: #8b5cf6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-num {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-cta {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: 0 4px 12px var(--green-glow);
        }

        .chat-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--green-glow);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text); }

        .tab.active {
            background: var(--bg-card);
            color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Panel */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        #search {
            width: 100%;
            padding: 18px 24px;
            padding-right: 120px;
            font-size: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            outline: none;
            transition: all 0.2s;
        }

        #search:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        #search::placeholder { color: var(--text-dim); }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover { transform: translateY(-50%) scale(1.02); }
        .search-btn:disabled { opacity: 0.5; }

        /* Filters */
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter:hover {
            border-color: var(--border-light);
            color: var(--text);
        }

        .filter.active {
            background: var(--accent-glow);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Results */
        .results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-dim);
            padding: 8px 0;
        }

        .result {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result:hover {
            border-color: var(--border-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .result-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-type {
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 6px;
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .result-type.document { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .result-type.email { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        .result-type.entity { background: rgba(16, 185, 129, 0.15); color: var(--green); }

        .result-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 0.95rem;
        }

        .result-content {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .result-content mark {
            background: rgba(59, 130, 246, 0.3);
            color: inherit;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Auto Panel */
        .auto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        /* Mode Toggle Switch */
        .mode-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .mode-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            color: var(--text-secondary);
        }

        .mode-btn:hover {
            color: var(--text);
        }

        .mode-btn.active {
            background: var(--bg-card);
            color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .mode-btn.active.auto-mode {
            background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
            color: white;
        }

        .auto-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-btn.start {
            background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
            color: white;
        }

        .auto-btn.stop {
            background: linear-gradient(135deg, var(--red) 0%, #dc2626 100%);
            color: white;
        }

        .auto-btn:hover { transform: translateY(-1px); }

        .auto-status {
            font-size: 0.9rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-status.running { color: var(--green); }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .status-dot.running {
            background: var(--green);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 var(--green-glow); }
            50% { opacity: 0.7; box-shadow: 0 0 0 8px transparent; }
        }

        .auto-description {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .discovery {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 3px solid var(--orange);
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }

        .discovery-question {
            font-weight: 600;
            color: var(--orange);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .discovery-answer {
            font-size: 0.85rem;
            line-height: 1.7;
            margin-bottom: 14px;
        }

        .discovery-answer .thinking {
            color: var(--accent);
            animation: pulse 1.5s infinite;
        }

        .discovery-answer strong {
            color: var(--text);
        }

        .discovery-answer li {
            margin-left: 16px;
            list-style: disc;
            color: var(--text-secondary);
        }

        .discovery-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .source-tag {
            padding: 5px 12px;
            background: var(--bg-hover);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Footer */
        footer {
            margin-top: 60px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        footer a {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        footer a:hover { color: var(--accent); }

        @media (max-width: 600px) {
            .container { padding: 24px 16px; }
            .logo { font-size: 2rem; }
            .stats-bar { gap: 20px; }
            .stat-num { font-size: 1.2rem; }
            .tabs { width: 100%; overflow-x: auto; }
            .search-btn span { display: none; }
            .auto-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">PWND.ICU</h1>
            <p class="subtitle">Epstein Documents Investigation Platform</p>
            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-num" id="doc-count">33,598</span>
                    <span class="stat-label">Documents</span>
                </div>
                <div class="stat">
                    <span class="stat-num" id="node-count">82,265</span>
                    <span class="stat-label">Entities</span>
                </div>
                <div class="stat">
                    <span class="stat-num" id="edge-count">4,291</span>
                    <span class="stat-label">Connections</span>
                </div>
            </div>
            <a href="/chat.html" class="chat-cta">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Chat with AI Assistant
            </a>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showPanel('search')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                Search
            </button>
            <button class="tab" onclick="showPanel('auto')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                Auto Explore
            </button>
            <button class="tab" onclick="showPanel('targets')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                </svg>
                Targets
            </button>
        </div>

        <!-- Search Panel -->
        <div id="search-panel" class="panel active">
            <div class="search-box">
                <input type="text" id="search" placeholder="Search documents, depositions, flight logs, emails..." autocomplete="off">
                <button class="search-btn" id="search-btn" onclick="doSearch()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <span>Search</span>
                </button>
            </div>

            <div class="filters">
                <button class="filter active" data-source="all">All Sources</button>
                <button class="filter" data-source="documents">Documents</button>
                <button class="filter" data-source="emails">Emails</button>
                <button class="filter" data-source="nodes">Entities</button>
            </div>

            <div id="results" class="results">
                <div class="empty">
                    <div class="empty-icon">üîç</div>
                    <p>Search across court filings, depositions, flight logs, emails, and FOIA releases</p>
                </div>
            </div>
        </div>

        <!-- Auto Explore Panel -->
        <div id="auto-panel" class="panel">
            <div class="auto-header">
                <div class="mode-toggle">
                    <button class="mode-btn active" id="normalModeBtn" onclick="setMode('normal')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        Normal
                    </button>
                    <button class="mode-btn" id="autoModeBtn" onclick="setMode('auto')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/>
                        </svg>
                        Auto
                    </button>
                </div>
                <div class="auto-status" id="auto-status">
                    <div class="status-dot"></div>
                    <span>Normal Mode</span>
                </div>
            </div>

            <div class="auto-description" id="mode-description">
                <strong>Normal Mode:</strong> Ask questions manually. The AI responds to your queries with sourced answers.
            </div>

            <!-- Manual query input for Normal mode -->
            <div id="manual-query-section" class="search-box" style="margin-bottom: 20px;">
                <input type="text" id="manual-query" placeholder="Ask a question about the documents..." autocomplete="off" style="width:100%;padding:18px 24px;padding-right:120px;font-size:1rem;background:var(--bg-card);border:2px solid var(--border);border-radius:16px;color:var(--text);outline:none;">
                <button class="search-btn" onclick="submitManualQuery()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    <span>Ask</span>
                </button>
            </div>

            <div id="discoveries" class="discoveries">
                <div class="empty" id="discoveries-empty">
                    <div class="empty-icon">üîç</div>
                    <p>Ask a question or switch to Auto mode for autonomous exploration</p>
                </div>
            </div>
        </div>

        <!-- Targets Panel -->
        <div id="targets-panel" class="panel">
            <div id="targets-list" class="results">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading prosecution targets...</p>
                </div>
            </div>
        </div>

        <footer>
            <a href="/chat.html">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                AI Chat
            </a>
            <a href="/thoughts.html">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/>
                </svg>
                Live Thoughts
            </a>
            <a href="/investigation.html">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                Investigation
            </a>
            <a href="/api/prosecution/export">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </a>
        </footer>
    </div>

    <script>
        let currentSource = 'all';
        let currentMode = localStorage.getItem('explorationMode') || 'normal';
        let autoRunning = false;
        let autoInterval = null;

        // Tab navigation
        function showPanel(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name + '-panel').classList.add('active');
            event.target.closest('.tab').classList.add('active');

            if (name === 'targets') loadTargets();
            if (name === 'auto') restoreMode();
        }

        // Mode toggle (Normal/Auto)
        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('explorationMode', mode);

            const normalBtn = document.getElementById('normalModeBtn');
            const autoBtn = document.getElementById('autoModeBtn');
            const status = document.getElementById('auto-status');
            const description = document.getElementById('mode-description');

            // Update toggle buttons
            normalBtn.classList.toggle('active', mode === 'normal');
            autoBtn.classList.toggle('active', mode === 'auto');
            autoBtn.classList.toggle('auto-mode', mode === 'auto');

            // Update status and description
            const manualSection = document.getElementById('manual-query-section');
            const emptyState = document.getElementById('discoveries-empty');

            if (mode === 'auto') {
                status.innerHTML = '<div class="status-dot running"></div><span>Auto Mode Active</span>';
                status.classList.add('running');
                description.innerHTML = '<strong>Auto Mode:</strong> AI autonomously explores documents, generates questions, and discovers patterns. Click any discovery to investigate further.';
                if (manualSection) manualSection.style.display = 'none';
                if (emptyState) emptyState.innerHTML = '<div class="empty-icon">ü§ñ</div><p>Starting autonomous exploration...</p>';
                startAutoExploration();
            } else {
                stopAutoExploration();
                status.innerHTML = '<div class="status-dot"></div><span>Normal Mode</span>';
                status.classList.remove('running');
                description.innerHTML = '<strong>Normal Mode:</strong> Ask questions manually. The AI responds to your queries with sourced answers.';
                if (manualSection) manualSection.style.display = 'block';
                if (emptyState) emptyState.innerHTML = '<div class="empty-icon">üîç</div><p>Ask a question or switch to Auto mode for autonomous exploration</p>';
            }
        }

        function restoreMode() {
            setMode(currentMode);
        }

        function startAutoExploration() {
            if (autoRunning) return;
            autoRunning = true;

            // Clear previous discoveries
            const discoveries = document.getElementById('discoveries');
            const empty = discoveries.querySelector('.empty');
            if (empty) empty.remove();

            // Start exploration loop
            runAutoQuestion();
            autoInterval = setInterval(runAutoQuestion, 8000);
        }

        function stopAutoExploration() {
            autoRunning = false;
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
            }
        }

        // Manual query submission (Normal mode)
        async function submitManualQuery() {
            const input = document.getElementById('manual-query');
            const query = input.value.trim();
            if (!query) return;

            input.value = '';

            // Remove empty state
            const empty = document.getElementById('discoveries-empty');
            if (empty) empty.remove();

            // Add discovery card for this query
            const discoveries = document.getElementById('discoveries');
            const div = document.createElement('div');
            div.className = 'discovery';
            div.innerHTML = `
                <div class="discovery-question">${escapeHtml(query)}</div>
                <div class="discovery-answer"><span class="thinking">Searching documents...</span></div>
                <div class="discovery-sources"></div>
            `;
            discoveries.insertBefore(div, discoveries.firstChild);

            // Use RAG endpoint
            await fetchAnswer(query, div);
        }

        // Handle Enter key for manual query
        document.addEventListener('DOMContentLoaded', () => {
            const manualInput = document.getElementById('manual-query');
            if (manualInput) {
                manualInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') submitManualQuery();
                });
            }
        });

        // Source filters
        document.querySelectorAll('.filter').forEach(f => {
            f.addEventListener('click', () => {
                document.querySelectorAll('.filter').forEach(x => x.classList.remove('active'));
                f.classList.add('active');
                currentSource = f.dataset.source;
            });
        });

        // Search
        document.getElementById('search').addEventListener('keydown', e => {
            if (e.key === 'Enter') doSearch();
        });

        async function doSearch() {
            const query = document.getElementById('search').value.trim();
            if (!query) return;

            const btn = document.getElementById('search-btn');
            const resultsDiv = document.getElementById('results');

            btn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            try {
                const results = await searchAll(query, currentSource);
                displayResults(results, query);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="empty"><p>Search error: ' + error.message + '</p></div>';
            }

            btn.disabled = false;
        }

        async function searchAll(query, source) {
            const results = [];

            if (source === 'all' || source === 'documents') {
                try {
                    const docRes = await fetch('/api/search?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                    docRes.forEach(d => {
                        results.push({
                            type: 'document',
                            title: d.name || d.title || 'Document',
                            content: cleanContent(d.snippet || ''),
                            score: d.score || 0
                        });
                    });
                } catch(e) {}
            }

            if (source === 'all' || source === 'emails') {
                try {
                    const emailRes = await fetch('/api/search/emails?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                    emailRes.forEach(e => {
                        results.push({
                            type: 'email',
                            title: e.title || e.subject || 'Email',
                            content: cleanContent(e.snippet || e.body || ''),
                            score: e.score || 0,
                            meta: e.sender || ''
                        });
                    });
                } catch(e) {}
            }

            if (source === 'all' || source === 'nodes') {
                try {
                    const nodeRes = await fetch('/api/search/nodes?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                    nodeRes.forEach(n => {
                        results.push({
                            type: 'entity',
                            title: n.name || n.title || 'Entity',
                            content: cleanContent(n.description || n.snippet || ''),
                            score: n.score || 0,
                            meta: n.type || ''
                        });
                    });
                } catch(e) {}
            }

            results.sort((a, b) => (b.score || 0) - (a.score || 0));
            return results;
        }

        function displayResults(results, query) {
            const resultsDiv = document.getElementById('results');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><p>No results found for "' + escapeHtml(query) + '"</p></div>';
                return;
            }

            const keywords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);

            let html = '<div class="result-header"><span>' + results.length + ' results for "' + escapeHtml(query) + '"</span></div>';

            results.forEach(r => {
                const highlighted = highlightKeywords(r.content.substring(0, 250), keywords);
                html += `
                    <div class="result">
                        <div class="result-meta">
                            <span class="result-type ${r.type}">${r.type}</span>
                            ${r.meta ? '<span style="color:var(--text-dim);font-size:0.75rem">' + escapeHtml(r.meta) + '</span>' : ''}
                        </div>
                        <div class="result-title">${escapeHtml(r.title)}</div>
                        <div class="result-content">${highlighted}${r.content.length > 250 ? '...' : ''}</div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Auto Exploration
        const AUTO_QUESTIONS = [
            "Who visited Little St. James island most frequently?",
            "What financial connections exist between Epstein and major corporations?",
            "Which witnesses changed their testimony over time?",
            "What patterns appear in the flight logs between 1999-2005?",
            "Who was present at key events mentioned in depositions?",
            "What evidence exists of obstruction of justice?",
            "Which law enforcement officials had contact with Epstein?",
            "What do the black book entries reveal about networking patterns?",
            "What inconsistencies exist between different witness accounts?",
            "What happened to evidence after Epstein's first arrest?",
            "Who benefited financially from Epstein's death?",
            "What connections exist to modeling agencies?",
            "What do the massage appointment records show?",
            "Which politicians appear in flight logs?",
            "What documents were sealed and why?",
            "What did employees testify about daily operations?",
            "What evidence links Maxwell to recruitment?",
            "What financial irregularities were documented?",
            "Who provided legal protection over the years?",
            "What do the photographs reveal about visitors?"
        ];

        let questionIndex = 0;

        // Legacy toggle function - now redirects to setMode
        function toggleAuto() {
            if (currentMode === 'auto') {
                setMode('normal');
            } else {
                setMode('auto');
            }
        }

        async function runAutoQuestion() {
            if (!autoRunning) return;

            const question = AUTO_QUESTIONS[questionIndex % AUTO_QUESTIONS.length];
            questionIndex++;

            const status = document.getElementById('auto-status');
            status.querySelector('span').textContent = 'Analyzing: ' + question.substring(0, 35) + '...';

            // Create discovery card immediately
            const discoveries = document.getElementById('discoveries');
            const empty = discoveries.querySelector('.empty');
            if (empty) empty.remove();

            const div = document.createElement('div');
            div.className = 'discovery';
            div.innerHTML = `
                <div class="discovery-question">${escapeHtml(question)}</div>
                <div class="discovery-answer"><span class="thinking">Analyzing documents...</span></div>
                <div class="discovery-sources"></div>
            `;
            discoveries.insertBefore(div, discoveries.firstChild);

            while (discoveries.children.length > 8) {
                discoveries.removeChild(discoveries.lastChild);
            }

            await fetchAnswer(question, div);

            // Update status after completion
            if (autoRunning) {
                status.innerHTML = '<div class="status-dot running"></div><span>Auto Mode Active</span>';
            }
        }

        // Shared function to fetch answer from RAG API
        async function fetchAnswer(question, div) {
            try {
                // Use RAG endpoint for intelligent analysis
                const response = await fetch('/api/ask?q=' + encodeURIComponent(question));
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let fullAnswer = '';
                let sources = [];
                const answerDiv = div.querySelector('.discovery-answer');
                const sourcesDiv = div.querySelector('.discovery-sources');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                if (data.type === 'chunk' && data.text) {
                                    fullAnswer += data.text;
                                    answerDiv.innerHTML = formatAnswer(fullAnswer);
                                }

                                if (data.type === 'status' && data.msg) {
                                    answerDiv.innerHTML = '<span class="thinking">' + escapeHtml(data.msg) + '</span>';
                                }

                                if (data.type === 'done') {
                                    if (data.sources && data.sources.length > 0) {
                                        sources = data.sources;
                                        sourcesDiv.innerHTML = sources.slice(0, 4).map(s => {
                                            const id = typeof s === 'number' ? s : (s.id || s);
                                            return `<span class="source-tag" onclick="window.open('/source.html?id=${id}', '_blank')">#${id}</span>`;
                                        }).join('');
                                    }
                                }
                            } catch (e) {}
                        }
                    }
                }

                if (!fullAnswer) {
                    answerDiv.innerHTML = '<em>No relevant information found in the archive.</em>';
                }

            } catch (e) {
                console.error('Fetch error:', e);
                div.querySelector('.discovery-answer').innerHTML = '<em>Analysis failed. Please try again.</em>';
            }
        }

        function formatAnswer(text) {
            let html = escapeHtml(text);
            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            // Bullet points
            html = html.replace(/^[-‚Ä¢] (.+)$/gm, '<li>$1</li>');
            // Newlines
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // Targets
        async function loadTargets() {
            const container = document.getElementById('targets-list');

            try {
                const targets = await fetch('/api/prosecution/targets').then(r => r.json());

                let html = '<div class="result-header"><span>' + targets.length + ' prosecution targets</span></div>';

                targets.forEach(t => {
                    const flagColor = t.guilt_flag >= 10 ? 'var(--red)' : t.guilt_flag >= 7 ? 'var(--orange)' : t.guilt_flag >= 4 ? 'var(--accent)' : 'var(--text-dim)';

                    html += `
                        <div class="result">
                            <div class="result-meta">
                                <span class="result-type" style="background: ${flagColor}; color: white;">Flag: ${t.guilt_flag}/12</span>
                                <span style="color:var(--text-dim);font-size:0.75rem">${t.status || 'Unknown'}</span>
                            </div>
                            <div class="result-title">${escapeHtml(t.name)}</div>
                            <div class="result-content">
                                <strong style="color:var(--text)">${t.flag_label}</strong><br>
                                Confidence: ${t.confidence}%
                                ${t.flag_reason ? '<br><span style="color:var(--text-dim)">' + escapeHtml(t.flag_reason) + '</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading targets</p></div>';
            }
        }

        // Utilities
        function highlightKeywords(text, keywords) {
            let result = escapeHtml(text);
            keywords.forEach(kw => {
                const regex = new RegExp('(' + escapeRegex(kw) + ')', 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });
            return result;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function cleanContent(text) {
            if (!text) return '';
            // Strip HTML tags
            let clean = text.replace(/<[^>]*>/g, '');
            // Remove URLs
            clean = clean.replace(/https?:\/\/[^\s<>"{}|\\^`\[\]]+/g, '');
            // Collapse whitespace
            clean = clean.replace(/\s+/g, ' ').trim();
            return clean;
        }

        // Load stats
        fetch('/api/stats')
            .then(r => r.json())
            .then(stats => {
                if (stats.total_documents) document.getElementById('doc-count').textContent = stats.total_documents.toLocaleString();
                if (stats.nodes) document.getElementById('node-count').textContent = stats.nodes.toLocaleString();
                if (stats.edges) document.getElementById('edge-count').textContent = stats.edges.toLocaleString();
            })
            .catch(() => {});

        // Focus search on load
        document.getElementById('search').focus();

        // Hot reload - check for updates every 3s
        let lastModified = null;
        setInterval(async () => {
            try {
                const res = await fetch('/index.html', { method: 'HEAD' });
                const modified = res.headers.get('last-modified');
                if (lastModified && modified !== lastModified) {
                    console.log('Hot reload triggered');
                    location.reload();
                }
                lastModified = modified;
            } catch(e) {}
        }, 3000);
    </script>
</body>
</html>
