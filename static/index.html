<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWND.ICU - Epstein Investigation</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-card: #141414;
            --bg-input: #1a1a1a;
            --border: #252525;
            --text: #e5e5e5;
            --text-dim: #888;
            --accent: #3b82f6;
            --accent-dim: #1d4ed8;
            --green: #22c55e;
            --orange: #f59e0b;
            --red: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .stat { display: flex; align-items: center; gap: 6px; }
        .stat-num { color: var(--accent); font-weight: 600; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px 8px 0 0;
            color: var(--text-dim);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text); }
        .tab.active {
            background: var(--bg-card);
            border-color: var(--border);
            border-bottom-color: var(--bg-card);
            color: var(--text);
        }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Search Panel */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        #search {
            width: 100%;
            padding: 14px 18px;
            padding-right: 100px;
            font-size: 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            outline: none;
        }

        #search:focus { border-color: var(--accent); }
        #search::placeholder { color: var(--text-dim); }

        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 18px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
        }

        .search-btn:hover { background: var(--accent-dim); }
        .search-btn:disabled { opacity: 0.5; }

        /* Source filters */
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .filter.active {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Results */
        .results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-dim);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .result {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .result:hover { border-color: #333; }

        .result-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .result-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .result-type {
            padding: 2px 8px;
            background: var(--bg-input);
            border-radius: 10px;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
        }

        .result-content {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text);
        }

        .result-content mark {
            background: rgba(59, 130, 246, 0.3);
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Auto Panel */
        .auto-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }

        .auto-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .auto-btn.start {
            background: var(--green);
            color: white;
        }

        .auto-btn.stop {
            background: var(--red);
            color: white;
        }

        .auto-status {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .auto-status.running {
            color: var(--green);
        }

        .discoveries {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .discovery {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .discovery-question {
            font-weight: 600;
            color: var(--orange);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .discovery-answer {
            font-size: 0.85rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .discovery-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .source-tag {
            padding: 3px 8px;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-dim);
        }

        /* Footer */
        footer {
            margin-top: 40px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        footer a { color: var(--accent); text-decoration: none; }

        @media (max-width: 600px) {
            .container { padding: 16px; }
            h1 { font-size: 1.5rem; }
            .tabs { overflow-x: auto; }
            .auto-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PWND.ICU</h1>
            <p class="subtitle">Epstein Documents Investigation Platform</p>
            <div class="stats-bar">
                <div class="stat"><span class="stat-num" id="doc-count">25,956</span> documents</div>
                <div class="stat"><span class="stat-num" id="node-count">-</span> entities</div>
                <div class="stat"><span class="stat-num" id="edge-count">-</span> connections</div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showPanel('search')">Search</button>
            <button class="tab" onclick="showPanel('auto')">Auto Explore</button>
            <button class="tab" onclick="showPanel('targets')">Targets</button>
        </div>

        <!-- Search Panel -->
        <div id="search-panel" class="panel active">
            <div class="search-box">
                <input type="text" id="search" placeholder="Search across all documents, emails, depositions..." autocomplete="off">
                <button class="search-btn" id="search-btn" onclick="doSearch()">Search</button>
            </div>

            <div class="filters">
                <button class="filter active" data-source="all">All Sources</button>
                <button class="filter" data-source="documents">Documents</button>
                <button class="filter" data-source="emails">Emails</button>
                <button class="filter" data-source="nodes">Entities</button>
            </div>

            <div id="results" class="results">
                <div class="empty">
                    <p>Search across court filings, depositions, flight logs, emails, and FOIA releases</p>
                </div>
            </div>
        </div>

        <!-- Auto Explore Panel -->
        <div id="auto-panel" class="panel">
            <div class="auto-controls">
                <button class="auto-btn start" id="auto-btn" onclick="toggleAuto()">Start Auto Exploration</button>
                <span class="auto-status" id="auto-status">Idle</span>
            </div>

            <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 20px;">
                Auto mode asks open-ended questions to discover patterns, connections, and anomalies in the document archive.
            </p>

            <div id="discoveries" class="discoveries">
                <div class="empty">
                    <p>Click "Start Auto Exploration" to begin discovering patterns</p>
                </div>
            </div>
        </div>

        <!-- Targets Panel -->
        <div id="targets-panel" class="panel">
            <div id="targets-list" class="results">
                <div class="loading"><div class="spinner"></div><p>Loading targets...</p></div>
            </div>
        </div>

        <footer>
            <p>Public court documents and FOIA releases | <a href="/thoughts">Investigation Notes</a> | <a href="/api/prosecution/export">Export All</a></p>
        </footer>
    </div>

    <script>
        let currentSource = 'all';
        let autoRunning = false;
        let autoInterval = null;

        // Tab navigation
        function showPanel(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name + '-panel').classList.add('active');
            event.target.classList.add('active');

            if (name === 'targets') loadTargets();
        }

        // Source filters
        document.querySelectorAll('.filter').forEach(f => {
            f.addEventListener('click', () => {
                document.querySelectorAll('.filter').forEach(x => x.classList.remove('active'));
                f.classList.add('active');
                currentSource = f.dataset.source;
            });
        });

        // Search
        document.getElementById('search').addEventListener('keydown', e => {
            if (e.key === 'Enter') doSearch();
        });

        async function doSearch() {
            const query = document.getElementById('search').value.trim();
            if (!query) return;

            const btn = document.getElementById('search-btn');
            const resultsDiv = document.getElementById('results');

            btn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            try {
                // Search across multiple sources
                const results = await searchAll(query, currentSource);
                displayResults(results, query);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="empty"><p>Search error: ' + error.message + '</p></div>';
            }

            btn.disabled = false;
        }

        async function searchAll(query, source) {
            const results = [];

            if (source === 'all' || source === 'documents') {
                const docRes = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: query })
                }).then(r => r.json());

                (docRes.sources || []).forEach(d => {
                    results.push({
                        type: 'document',
                        title: d.title || 'Document',
                        content: d.snippet || '',
                        score: d.score || 0
                    });
                });
            }

            if (source === 'all' || source === 'emails') {
                const emailRes = await fetch('/api/search/emails?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                emailRes.forEach(e => {
                    results.push({
                        type: 'email',
                        title: e.title || e.subject || 'Email',
                        content: e.snippet || e.body || '',
                        score: e.score || 0,
                        meta: e.sender || ''
                    });
                });
            }

            if (source === 'all' || source === 'nodes') {
                const nodeRes = await fetch('/api/search/nodes?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                nodeRes.forEach(n => {
                    results.push({
                        type: 'entity',
                        title: n.name || n.title || 'Entity',
                        content: n.description || n.snippet || '',
                        score: n.score || 0,
                        meta: n.type || ''
                    });
                });
            }

            // Sort by score
            results.sort((a, b) => (b.score || 0) - (a.score || 0));
            return results;
        }

        function displayResults(results, query) {
            const resultsDiv = document.getElementById('results');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="empty"><p>No results found for "' + escapeHtml(query) + '"</p></div>';
                return;
            }

            const keywords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);

            let html = '<div class="result-header"><span>' + results.length + ' results</span></div>';

            results.forEach(r => {
                const highlighted = highlightKeywords(r.content.substring(0, 300), keywords);
                html += `
                    <div class="result">
                        <div class="result-meta">
                            <span class="result-type">${r.type}</span>
                            ${r.meta ? '<span>' + escapeHtml(r.meta) + '</span>' : ''}
                        </div>
                        <div class="result-title">${escapeHtml(r.title)}</div>
                        <div class="result-content">${highlighted}...</div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Auto Exploration
        const AUTO_QUESTIONS = [
            "Who visited Little St. James island most frequently?",
            "What financial connections exist between Epstein and major corporations?",
            "Which witnesses changed their testimony over time?",
            "What patterns appear in the flight logs between 1999-2005?",
            "Who was present at key events mentioned in depositions?",
            "What evidence exists of obstruction of justice?",
            "Which law enforcement officials had contact with Epstein?",
            "What do the black book entries reveal about networking patterns?",
            "What inconsistencies exist between different witness accounts?",
            "What happened to evidence after Epstein's first arrest?",
            "Who benefited financially from Epstein's death?",
            "What connections exist to modeling agencies?",
            "What do the massage appointment records show?",
            "Which politicians appear in flight logs?",
            "What documents were sealed and why?",
            "What did employees testify about daily operations?",
            "What evidence links Maxwell to recruitment?",
            "What financial irregularities were documented?",
            "Who provided legal protection over the years?",
            "What do the photographs reveal about visitors?"
        ];

        let questionIndex = 0;

        function toggleAuto() {
            const btn = document.getElementById('auto-btn');
            const status = document.getElementById('auto-status');

            if (autoRunning) {
                autoRunning = false;
                clearInterval(autoInterval);
                btn.textContent = 'Start Auto Exploration';
                btn.classList.remove('stop');
                btn.classList.add('start');
                status.textContent = 'Stopped';
                status.classList.remove('running');
            } else {
                autoRunning = true;
                btn.textContent = 'Stop';
                btn.classList.remove('start');
                btn.classList.add('stop');
                status.textContent = 'Running...';
                status.classList.add('running');

                document.getElementById('discoveries').innerHTML = '';
                runAutoQuestion();
                autoInterval = setInterval(runAutoQuestion, 8000);
            }
        }

        async function runAutoQuestion() {
            if (!autoRunning) return;

            const question = AUTO_QUESTIONS[questionIndex % AUTO_QUESTIONS.length];
            questionIndex++;

            const status = document.getElementById('auto-status');
            status.textContent = 'Exploring: ' + question.substring(0, 40) + '...';

            try {
                const results = await searchAll(question, 'all');
                addDiscovery(question, results);
            } catch (e) {
                console.error('Auto error:', e);
            }
        }

        function addDiscovery(question, results) {
            const discoveries = document.getElementById('discoveries');

            // Remove empty state
            const empty = discoveries.querySelector('.empty');
            if (empty) empty.remove();

            // Summarize findings
            let summary = '';
            const sourceTags = [];

            if (results.length === 0) {
                summary = 'No direct matches found in the archive for this query.';
            } else {
                const topResults = results.slice(0, 3);
                summary = 'Found ' + results.length + ' relevant documents. Key findings:\n\n';
                topResults.forEach((r, i) => {
                    summary += 'â€¢ ' + r.content.substring(0, 200).replace(/\n/g, ' ') + '...\n\n';
                    if (r.title) sourceTags.push(r.title.substring(0, 25));
                });
            }

            const div = document.createElement('div');
            div.className = 'discovery';
            div.innerHTML = `
                <div class="discovery-question">${escapeHtml(question)}</div>
                <div class="discovery-answer">${escapeHtml(summary).replace(/\n/g, '<br>')}</div>
                <div class="discovery-sources">
                    ${sourceTags.map(s => '<span class="source-tag">' + escapeHtml(s) + '</span>').join('')}
                </div>
            `;

            discoveries.insertBefore(div, discoveries.firstChild);

            // Keep only last 10 discoveries
            while (discoveries.children.length > 10) {
                discoveries.removeChild(discoveries.lastChild);
            }
        }

        // Targets
        async function loadTargets() {
            const container = document.getElementById('targets-list');

            try {
                const targets = await fetch('/api/prosecution/targets').then(r => r.json());

                let html = '<div class="result-header"><span>' + targets.length + ' prosecution targets</span></div>';

                targets.forEach(t => {
                    const flagColor = t.guilt_flag >= 10 ? 'var(--red)' : t.guilt_flag >= 7 ? 'var(--orange)' : t.guilt_flag >= 4 ? 'var(--accent)' : 'var(--text-dim)';

                    html += `
                        <div class="result">
                            <div class="result-meta">
                                <span class="result-type" style="background: ${flagColor}; color: white;">Flag: ${t.guilt_flag}/12</span>
                                <span>${t.status || 'Unknown'}</span>
                            </div>
                            <div class="result-title">${escapeHtml(t.name)}</div>
                            <div class="result-content">
                                <strong>${t.flag_label}</strong><br>
                                Confidence: ${t.confidence}%
                                ${t.flag_reason ? '<br><em>' + escapeHtml(t.flag_reason) + '</em>' : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="empty"><p>Error loading targets</p></div>';
            }
        }

        // Utilities
        function highlightKeywords(text, keywords) {
            let result = escapeHtml(text);
            keywords.forEach(kw => {
                const regex = new RegExp('(' + escapeRegex(kw) + ')', 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });
            return result;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Load stats
        fetch('/api/stats')
            .then(r => r.json())
            .then(stats => {
                if (stats.total_documents) document.getElementById('doc-count').textContent = stats.total_documents.toLocaleString();
                if (stats.nodes) document.getElementById('node-count').textContent = stats.nodes.toLocaleString();
                if (stats.edges) document.getElementById('edge-count').textContent = stats.edges.toLocaleString();
            })
            .catch(() => {});
    </script>
</body>
</html>
