<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWND.ICU - Epstein Investigation</title>
    <style>
        :root {
            --bg: #0d0d0d;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --bg-input: #222;
            --bg-hover: #2a2a2a;
            --border: #2a2a2a;
            --border-light: #333;
            --text: #f0f0f0;
            --text-secondary: #999;
            --text-dim: #666;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.15);
            --green: #10b981;
            --green-glow: rgba(16, 185, 129, 0.15);
            --orange: #f59e0b;
            --red: #ef4444;
            --purple: #8b5cf6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-num {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-cta {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: 0 4px 12px var(--green-glow);
        }

        .chat-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--green-glow);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text); }

        .tab.active {
            background: var(--bg-card);
            color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Panel */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        #search {
            width: 100%;
            padding: 18px 24px;
            padding-right: 120px;
            font-size: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            outline: none;
            transition: all 0.2s;
        }

        #search:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        #search::placeholder { color: var(--text-dim); }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover { transform: translateY(-50%) scale(1.02); }
        .search-btn:disabled { opacity: 0.5; }

        /* Filters */
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter:hover {
            border-color: var(--border-light);
            color: var(--text);
        }

        .filter.active {
            background: var(--accent-glow);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Results */
        .results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-dim);
            padding: 8px 0;
        }

        .result {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result:hover {
            border-color: var(--border-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .result-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-type {
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 6px;
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .result-type.document { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .result-type.email { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
        .result-type.entity { background: rgba(16, 185, 129, 0.15); color: var(--green); }

        .result-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 0.95rem;
        }

        .result-content {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .result-content mark {
            background: rgba(59, 130, 246, 0.3);
            color: inherit;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Auto Panel */
        .auto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .auto-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-btn.start {
            background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
            color: white;
        }

        .auto-btn.stop {
            background: linear-gradient(135deg, var(--red) 0%, #dc2626 100%);
            color: white;
        }

        .auto-btn:hover { transform: translateY(-1px); }

        .auto-status {
            font-size: 0.9rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-status.running { color: var(--green); }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .status-dot.running {
            background: var(--green);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 var(--green-glow); }
            50% { opacity: 0.7; box-shadow: 0 0 0 8px transparent; }
        }

        .auto-description {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .discovery {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 3px solid var(--orange);
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease;
        }

        .discovery-question {
            font-weight: 600;
            color: var(--orange);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .discovery-answer {
            font-size: 0.85rem;
            line-height: 1.7;
            margin-bottom: 14px;
            color: var(--text-secondary);
        }

        .discovery-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .source-tag {
            padding: 5px 12px;
            background: var(--bg-hover);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Footer */
        footer {
            margin-top: 60px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        footer a {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        footer a:hover { color: var(--accent); }

        @media (max-width: 600px) {
            .container { padding: 24px 16px; }
            .logo { font-size: 2rem; }
            .stats-bar { gap: 20px; }
            .stat-num { font-size: 1.2rem; }
            .tabs { width: 100%; overflow-x: auto; }
            .search-btn span { display: none; }
            .auto-header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">PWND.ICU</h1>
            <p class="subtitle">Epstein Documents Investigation Platform</p>
            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-num" id="doc-count">33,598</span>
                    <span class="stat-label">Documents</span>
                </div>
                <div class="stat">
                    <span class="stat-num" id="node-count">82,265</span>
                    <span class="stat-label">Entities</span>
                </div>
                <div class="stat">
                    <span class="stat-num" id="edge-count">4,291</span>
                    <span class="stat-label">Connections</span>
                </div>
            </div>
            <a href="/chat.html" class="chat-cta">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Chat with AI Assistant
            </a>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showPanel('search')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                Search
            </button>
            <button class="tab" onclick="showPanel('auto')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                Auto Explore
            </button>
            <button class="tab" onclick="showPanel('targets')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;vertical-align:middle">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                </svg>
                Targets
            </button>
        </div>

        <!-- Search Panel -->
        <div id="search-panel" class="panel active">
            <div class="search-box">
                <input type="text" id="search" placeholder="Search documents, depositions, flight logs, emails..." autocomplete="off">
                <button class="search-btn" id="search-btn" onclick="doSearch()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <span>Search</span>
                </button>
            </div>

            <div class="filters">
                <button class="filter active" data-source="all">All Sources</button>
                <button class="filter" data-source="documents">Documents</button>
                <button class="filter" data-source="emails">Emails</button>
                <button class="filter" data-source="nodes">Entities</button>
            </div>

            <div id="results" class="results">
                <div class="empty">
                    <div class="empty-icon">üîç</div>
                    <p>Search across court filings, depositions, flight logs, emails, and FOIA releases</p>
                </div>
            </div>
        </div>

        <!-- Auto Explore Panel -->
        <div id="auto-panel" class="panel">
            <div class="auto-header">
                <button class="auto-btn start" id="auto-btn" onclick="toggleAuto()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    Start Exploration
                </button>
                <div class="auto-status" id="auto-status">
                    <div class="status-dot"></div>
                    <span>Idle</span>
                </div>
            </div>

            <div class="auto-description">
                Auto mode intelligently explores the document archive, asking questions to discover patterns,
                connections, and anomalies. Each query searches across all 33,598 documents.
            </div>

            <div id="discoveries" class="discoveries">
                <div class="empty">
                    <div class="empty-icon">ü§ñ</div>
                    <p>Click "Start Exploration" to begin automated discovery</p>
                </div>
            </div>
        </div>

        <!-- Targets Panel -->
        <div id="targets-panel" class="panel">
            <div id="targets-list" class="results">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading prosecution targets...</p>
                </div>
            </div>
        </div>

        <footer>
            <a href="/chat.html">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                AI Chat
            </a>
            <a href="/thoughts.html">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6v6l4 2"/>
                </svg>
                Live Thoughts
            </a>
            <a href="/investigation.html">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                Investigation
            </a>
            <a href="/api/prosecution/export">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
            </a>
        </footer>
    </div>

    <script>
        let currentSource = 'all';
        let autoRunning = false;
        let autoInterval = null;

        // Tab navigation
        function showPanel(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name + '-panel').classList.add('active');
            event.target.closest('.tab').classList.add('active');

            if (name === 'targets') loadTargets();
        }

        // Source filters
        document.querySelectorAll('.filter').forEach(f => {
            f.addEventListener('click', () => {
                document.querySelectorAll('.filter').forEach(x => x.classList.remove('active'));
                f.classList.add('active');
                currentSource = f.dataset.source;
            });
        });

        // Search
        document.getElementById('search').addEventListener('keydown', e => {
            if (e.key === 'Enter') doSearch();
        });

        async function doSearch() {
            const query = document.getElementById('search').value.trim();
            if (!query) return;

            const btn = document.getElementById('search-btn');
            const resultsDiv = document.getElementById('results');

            btn.disabled = true;
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            try {
                const results = await searchAll(query, currentSource);
                displayResults(results, query);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="empty"><p>Search error: ' + error.message + '</p></div>';
            }

            btn.disabled = false;
        }

        async function searchAll(query, source) {
            const results = [];

            if (source === 'all' || source === 'documents') {
                try {
                    const docRes = await fetch('/api/search?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                    docRes.forEach(d => {
                        results.push({
                            type: 'document',
                            title: d.name || d.title || 'Document',
                            content: cleanContent(d.snippet || ''),
                            score: d.score || 0
                        });
                    });
                } catch(e) {}
            }

            if (source === 'all' || source === 'emails') {
                try {
                    const emailRes = await fetch('/api/search/emails?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                    emailRes.forEach(e => {
                        results.push({
                            type: 'email',
                            title: e.title || e.subject || 'Email',
                            content: cleanContent(e.snippet || e.body || ''),
                            score: e.score || 0,
                            meta: e.sender || ''
                        });
                    });
                } catch(e) {}
            }

            if (source === 'all' || source === 'nodes') {
                try {
                    const nodeRes = await fetch('/api/search/nodes?q=' + encodeURIComponent(query) + '&limit=20').then(r => r.json());
                    nodeRes.forEach(n => {
                        results.push({
                            type: 'entity',
                            title: n.name || n.title || 'Entity',
                            content: cleanContent(n.description || n.snippet || ''),
                            score: n.score || 0,
                            meta: n.type || ''
                        });
                    });
                } catch(e) {}
            }

            results.sort((a, b) => (b.score || 0) - (a.score || 0));
            return results;
        }

        function displayResults(results, query) {
            const resultsDiv = document.getElementById('results');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><p>No results found for "' + escapeHtml(query) + '"</p></div>';
                return;
            }

            const keywords = query.toLowerCase().split(/\s+/).filter(w => w.length > 2);

            let html = '<div class="result-header"><span>' + results.length + ' results for "' + escapeHtml(query) + '"</span></div>';

            results.forEach(r => {
                const highlighted = highlightKeywords(r.content.substring(0, 250), keywords);
                html += `
                    <div class="result">
                        <div class="result-meta">
                            <span class="result-type ${r.type}">${r.type}</span>
                            ${r.meta ? '<span style="color:var(--text-dim);font-size:0.75rem">' + escapeHtml(r.meta) + '</span>' : ''}
                        </div>
                        <div class="result-title">${escapeHtml(r.title)}</div>
                        <div class="result-content">${highlighted}${r.content.length > 250 ? '...' : ''}</div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Auto Exploration
        const AUTO_QUESTIONS = [
            "Who visited Little St. James island most frequently?",
            "What financial connections exist between Epstein and major corporations?",
            "Which witnesses changed their testimony over time?",
            "What patterns appear in the flight logs between 1999-2005?",
            "Who was present at key events mentioned in depositions?",
            "What evidence exists of obstruction of justice?",
            "Which law enforcement officials had contact with Epstein?",
            "What do the black book entries reveal about networking patterns?",
            "What inconsistencies exist between different witness accounts?",
            "What happened to evidence after Epstein's first arrest?",
            "Who benefited financially from Epstein's death?",
            "What connections exist to modeling agencies?",
            "What do the massage appointment records show?",
            "Which politicians appear in flight logs?",
            "What documents were sealed and why?",
            "What did employees testify about daily operations?",
            "What evidence links Maxwell to recruitment?",
            "What financial irregularities were documented?",
            "Who provided legal protection over the years?",
            "What do the photographs reveal about visitors?"
        ];

        let questionIndex = 0;

        function toggleAuto() {
            const btn = document.getElementById('auto-btn');
            const status = document.getElementById('auto-status');

            if (autoRunning) {
                autoRunning = false;
                clearInterval(autoInterval);
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    Start Exploration
                `;
                btn.classList.remove('stop');
                btn.classList.add('start');
                status.innerHTML = '<div class="status-dot"></div><span>Stopped</span>';
                status.classList.remove('running');
            } else {
                autoRunning = true;
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                    </svg>
                    Stop
                `;
                btn.classList.remove('start');
                btn.classList.add('stop');
                status.innerHTML = '<div class="status-dot running"></div><span>Running...</span>';
                status.classList.add('running');

                document.getElementById('discoveries').innerHTML = '';
                runAutoQuestion();
                autoInterval = setInterval(runAutoQuestion, 8000);
            }
        }

        async function runAutoQuestion() {
            if (!autoRunning) return;

            const question = AUTO_QUESTIONS[questionIndex % AUTO_QUESTIONS.length];
            questionIndex++;

            const status = document.getElementById('auto-status');
            status.querySelector('span').textContent = 'Exploring: ' + question.substring(0, 35) + '...';

            try {
                const results = await searchAll(question, 'all');
                addDiscovery(question, results);
            } catch (e) {
                console.error('Auto error:', e);
            }
        }

        function addDiscovery(question, results) {
            const discoveries = document.getElementById('discoveries');
            const empty = discoveries.querySelector('.empty');
            if (empty) empty.remove();

            let summary = '';
            const sourceTags = [];

            if (results.length === 0) {
                summary = 'No direct matches found in the archive for this query.';
            } else {
                const topResults = results.slice(0, 3);
                summary = 'Found ' + results.length + ' relevant documents:\n\n';
                topResults.forEach((r, i) => {
                    summary += '‚Ä¢ ' + r.content.substring(0, 180).replace(/\n/g, ' ') + '...\n\n';
                    if (r.title) sourceTags.push(r.title.substring(0, 30));
                });
            }

            const div = document.createElement('div');
            div.className = 'discovery';
            div.innerHTML = `
                <div class="discovery-question">${escapeHtml(question)}</div>
                <div class="discovery-answer">${escapeHtml(summary).replace(/\n/g, '<br>')}</div>
                <div class="discovery-sources">
                    ${sourceTags.map(s => '<span class="source-tag">' + escapeHtml(s) + '</span>').join('')}
                </div>
            `;

            discoveries.insertBefore(div, discoveries.firstChild);

            while (discoveries.children.length > 10) {
                discoveries.removeChild(discoveries.lastChild);
            }
        }

        // Targets
        async function loadTargets() {
            const container = document.getElementById('targets-list');

            try {
                const targets = await fetch('/api/prosecution/targets').then(r => r.json());

                let html = '<div class="result-header"><span>' + targets.length + ' prosecution targets</span></div>';

                targets.forEach(t => {
                    const flagColor = t.guilt_flag >= 10 ? 'var(--red)' : t.guilt_flag >= 7 ? 'var(--orange)' : t.guilt_flag >= 4 ? 'var(--accent)' : 'var(--text-dim)';

                    html += `
                        <div class="result">
                            <div class="result-meta">
                                <span class="result-type" style="background: ${flagColor}; color: white;">Flag: ${t.guilt_flag}/12</span>
                                <span style="color:var(--text-dim);font-size:0.75rem">${t.status || 'Unknown'}</span>
                            </div>
                            <div class="result-title">${escapeHtml(t.name)}</div>
                            <div class="result-content">
                                <strong style="color:var(--text)">${t.flag_label}</strong><br>
                                Confidence: ${t.confidence}%
                                ${t.flag_reason ? '<br><span style="color:var(--text-dim)">' + escapeHtml(t.flag_reason) + '</span>' : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading targets</p></div>';
            }
        }

        // Utilities
        function highlightKeywords(text, keywords) {
            let result = escapeHtml(text);
            keywords.forEach(kw => {
                const regex = new RegExp('(' + escapeRegex(kw) + ')', 'gi');
                result = result.replace(regex, '<mark>$1</mark>');
            });
            return result;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function cleanContent(text) {
            if (!text) return '';
            // Strip HTML tags
            let clean = text.replace(/<[^>]*>/g, '');
            // Remove URLs
            clean = clean.replace(/https?:\/\/[^\s<>"{}|\\^`\[\]]+/g, '');
            // Collapse whitespace
            clean = clean.replace(/\s+/g, ' ').trim();
            return clean;
        }

        // Load stats
        fetch('/api/stats')
            .then(r => r.json())
            .then(stats => {
                if (stats.total_documents) document.getElementById('doc-count').textContent = stats.total_documents.toLocaleString();
                if (stats.nodes) document.getElementById('node-count').textContent = stats.nodes.toLocaleString();
                if (stats.edges) document.getElementById('edge-count').textContent = stats.edges.toLocaleString();
            })
            .catch(() => {});

        // Focus search on load
        document.getElementById('search').focus();
    </script>
</body>
</html>
