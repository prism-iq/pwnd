<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWND.ICU - Investigation Platform</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-card: #141414;
            --bg-hover: #1a1a1a;
            --bg-input: #1e1e1e;
            --border: #252525;
            --text: #e5e5e5;
            --text-dim: #888;
            --accent: #3b82f6;
            --green: #22c55e;
            --orange: #f59e0b;
            --red: #ef4444;
            --purple: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }
        .app { display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .stat-num { color: var(--text); font-weight: 600; }

        /* Nav */
        .nav { padding: 12px; flex: 1; overflow-y: auto; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 8px;
            color: var(--text-dim);
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.15s;
        }
        .nav-item:hover { background: var(--bg-hover); color: var(--text); }
        .nav-item.active { background: var(--accent); color: white; }
        .nav-item svg { width: 18px; height: 18px; }

        .conversations { margin-top: 16px; }
        .conv-title { font-size: 0.7rem; color: var(--text-dim); padding: 8px 14px; text-transform: uppercase; }
        .conv-item {
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-dim);
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conv-item:hover { background: var(--bg-hover); color: var(--text); }
        .conv-item.active { background: var(--bg-hover); color: var(--text); }

        /* Main */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Header */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { font-size: 1rem; font-weight: 600; }

        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 24px; }

        /* Search Tab */
        .search-box { position: relative; margin-bottom: 20px; }
        .search-input {
            width: 100%;
            padding: 14px 18px;
            padding-right: 100px;
            font-size: 0.95rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            outline: none;
        }
        .search-input:focus { border-color: var(--accent); }
        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 18px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .results { display: flex; flex-direction: column; gap: 10px; }
        .result {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
        }
        .result:hover { border-color: var(--accent); }
        .result-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .result-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .result-type.email { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .result-type.document { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .result-type.person { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .result-title { font-weight: 600; font-size: 0.9rem; }
        .result-snippet { font-size: 0.8rem; color: var(--text-dim); }

        /* Chat Tab */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message {
            max-width: 80%;
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .message.user {
            background: var(--accent);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .message.assistant strong { color: var(--text); }
        .message.assistant h2 { font-size: 1.1rem; margin: 16px 0 12px 0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 6px; }
        .message.assistant h3 { font-size: 0.95rem; margin: 14px 0 8px 0; color: var(--text); }
        .message.assistant blockquote {
            border-left: 3px solid var(--accent);
            margin: 8px 0;
            padding: 8px 12px;
            background: var(--bg-hover);
            border-radius: 0 6px 6px 0;
            font-size: 0.85rem;
            color: var(--text-dim);
        }
        .message.assistant ul, .message.assistant ol { margin: 8px 0; padding-left: 20px; }
        .message.assistant li { margin: 4px 0; }
        .message.assistant hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
        .message.assistant em { color: var(--text-dim); font-style: italic; }
        .message.assistant code { background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
        .message.status {
            background: transparent;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
            max-width: 100%;
        }
        .message-sources {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .sources-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sources-btn:hover { background: var(--bg-input); color: var(--text); border-color: var(--accent); }
        .sources-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .sources-btn svg { width: 14px; height: 14px; }
        .sources-list {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .sources-list.active { display: block; }
        .source-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .source-item:hover { border-color: var(--accent); }
        .source-item:last-child { margin-bottom: 0; }
        .source-id { color: var(--accent); font-weight: 600; }
        .source-type {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        .chat-input-box { display: flex; gap: 10px; }
        .chat-input {
            flex: 1;
            padding: 14px 18px;
            font-size: 0.95rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            outline: none;
            resize: none;
        }
        .chat-input:focus { border-color: var(--accent); }
        .chat-send {
            padding: 14px 24px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Graph/Targets Tab */
        .entity-list { display: flex; flex-direction: column; gap: 8px; }
        .entity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }
        .entity-item:hover { border-color: var(--accent); }
        .entity-name { font-weight: 500; }
        .entity-scores { font-size: 0.75rem; color: var(--text-dim); }

        /* Network Visualization */
        .graph-container { display: flex; flex-direction: column; height: 100%; }
        .graph-controls {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }
        .graph-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }
        .graph-search:focus { border-color: var(--accent); outline: none; }
        .graph-btn {
            padding: 10px 18px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .graph-btn:hover { opacity: 0.9; }
        .graph-btn.secondary {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            color: var(--text);
        }
        .graph-legend {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        #network-container, #timeline-container {
            flex: 1;
            background: var(--bg);
            border-radius: 8px;
            min-height: 500px;
        }
        #timeline-container { display: none; }
        #timeline-container.active { display: block; }
        #network-container.hidden { display: none; }
        .mode-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-input);
            padding: 3px;
            border-radius: 6px;
            margin-right: 12px;
        }
        .mode-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.15s;
        }
        .mode-btn:hover { color: var(--text); }
        .mode-btn.active { background: var(--accent); color: white; }
        /* Timeline styles */
        .vis-timeline {
            border: none !important;
            background: var(--bg) !important;
        }
        .vis-item {
            background: var(--bg-card) !important;
            border-color: var(--border) !important;
            color: var(--text) !important;
            border-radius: 4px !important;
            font-size: 0.75rem !important;
        }
        .vis-item.vis-selected { border-color: var(--accent) !important; }
        .vis-item.legal { background: var(--accent) !important; border-color: var(--accent) !important; }
        .vis-item.death { background: var(--red) !important; border-color: var(--red) !important; }
        .vis-item.arrest { background: var(--orange) !important; border-color: var(--orange) !important; }
        .vis-item.investigation { background: var(--purple) !important; border-color: var(--purple) !important; }
        .vis-item.media { background: var(--green) !important; border-color: var(--green) !important; }
        .vis-item.custody { background: #6b7280 !important; border-color: #6b7280 !important; }
        .vis-item.event { background: #4b5563 !important; border-color: #4b5563 !important; }
        .vis-item.incident { background: #dc2626 !important; border-color: #dc2626 !important; }
        .vis-time-axis .vis-text { color: var(--text-dim) !important; fill: var(--text-dim) !important; }
        .timeline-filter {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-dim);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.15s;
        }
        .timeline-filter:hover { border-color: var(--accent); color: var(--text); }
        .timeline-filter.active { background: var(--accent); border-color: var(--accent); color: white; }
        .vis-panel.vis-background { background: var(--bg) !important; }
        .vis-panel.vis-center { background: var(--bg) !important; }
        .graph-info {
            padding: 10px 14px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .node-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            max-width: 300px;
            z-index: 100;
            display: none;
        }
        .node-tooltip.active { display: block; }
        .node-tooltip h4 { margin-bottom: 8px; color: var(--accent); }
        .node-tooltip p { margin: 4px 0; color: var(--text-dim); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 40px;
            overflow-y: auto;
        }
        .modal.active { display: block; }
        .modal-content {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
        }
        .modal-close {
            float: right;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; }
        .modal-body { white-space: pre-wrap; font-size: 0.85rem; line-height: 1.6; }

        .hidden { display: none !important; }
        .loading { color: var(--text-dim); padding: 40px; text-align: center; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .message { max-width: 95%; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">PWND.ICU</div>
                <div class="stats">
                    <span><span class="stat-num" id="stat-docs">-</span> docs</span>
                    <span><span class="stat-num" id="stat-nodes">-</span> entities</span>
                </div>
            </div>
            <div class="nav">
                <div class="nav-item active" data-tab="chat" onclick="showTab('chat')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Chat
                </div>
                <div class="nav-item" data-tab="search" onclick="showTab('search')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    Search
                </div>
                <div class="nav-item" data-tab="graph" onclick="showTab('graph')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/>
                    </svg>
                    Graph
                </div>
                <div class="nav-item" data-tab="targets" onclick="showTab('targets')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                    </svg>
                    Targets
                </div>

                <div class="conversations">
                    <div class="conv-title">Recent Chats</div>
                    <div id="conv-list"></div>
                </div>
            </div>
        </div>

        <!-- Main -->
        <div class="main">
            <div class="header">
                <div class="header-title" id="header-title">Chat</div>
                <button onclick="newChat()" style="padding:8px 16px;background:var(--accent);border:none;border-radius:6px;color:white;cursor:pointer;">New Chat</button>
            </div>

            <!-- Chat Tab -->
            <div id="tab-chat" class="content chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant">
                        Welcome to the Epstein Investigation Platform. Ask me anything about the documents, emails, or entities in the archive.
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-box">
                        <textarea class="chat-input" id="chat-input" placeholder="Ask about the investigation..." rows="1"></textarea>
                        <button class="chat-send" id="chat-send" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>

            <!-- Search Tab -->
            <div id="tab-search" class="content hidden">
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="Search documents, emails, entities...">
                    <button class="search-btn" onclick="doSearch()">Search</button>
                    <div class="search-engine-toggle" style="display:flex;gap:5px;margin-left:10px;">
                        <button class="filter-btn active" id="engine-pg" onclick="setSearchEngine('pg')">PostgreSQL</button>
                        <button class="filter-btn" id="engine-blood" onclick="setSearchEngine('blood')">Blood (C++)</button>
                    </div>
                </div>
                <div id="search-stats" style="font-size:12px;color:#888;margin-bottom:10px;"></div>
                <div class="results" id="search-results">
                    <div class="loading">Enter a search query</div>
                </div>
            </div>

            <!-- Graph Tab -->
            <div id="tab-graph" class="content hidden graph-container">
                <div class="graph-controls">
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="mode-network" onclick="setGraphMode('network')">Network</button>
                        <button class="mode-btn" id="mode-timeline" onclick="setGraphMode('timeline')">Timeline</button>
                    </div>
                    <input type="text" class="graph-search" id="graph-search" placeholder="Search entity (e.g., Jeffrey Epstein, Clinton, Maxwell...)">
                    <select class="graph-search" id="edge-type-filter" style="flex:0.5;min-width:150px;">
                        <option value="">All relations</option>
                    </select>
                    <button class="graph-btn" onclick="loadNetwork()">Explore</button>
                    <button class="graph-btn secondary" onclick="loadNetwork('Jeffrey Epstein')">Epstein</button>
                    <button class="graph-btn secondary" onclick="loadNetwork('Ghislaine Maxwell')">Maxwell</button>
                </div>
                <div class="graph-controls" style="padding-top:0;border:none;">
                    <div class="graph-legend">
                        <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> Person</div>
                        <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> Organization</div>
                        <div class="legend-item"><span class="legend-dot" style="background:#22c55e"></span> Company</div>
                        <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span> Location</div>
                        <div class="legend-item"><span class="legend-dot" style="background:#8b5cf6"></span> Email</div>
                    </div>
                    <div id="quick-filters" class="graph-legend" style="margin-left:auto;">
                        <span style="color:var(--text-dim);font-size:0.75rem;">Quick:</span>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="setEdgeFilter('flew_with')">Flights</button>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="setEdgeFilter('accuser_of')">Accusers</button>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="setEdgeFilter('associate_of,employed_by,worked_with')">Associates</button>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="setEdgeFilter('legal_co_mention')">Legal</button>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="setEdgeFilter('')">All</button>
                        <span style="color:var(--border);margin:0 4px;">|</span>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="exportPNG()">PNG</button>
                        <button class="graph-btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="exportJSON()">JSON</button>
                    </div>
                </div>
                <div id="network-container"></div>
                <div id="timeline-container"></div>
                <div class="graph-info" id="graph-info">
                    Click "Explore" to load the network, or search for a specific entity. Double-click a node to center on it.
                </div>
                <div class="graph-info" id="timeline-info" style="display:none;">
                    <div id="timeline-filters" class="graph-legend" style="gap:8px;flex-wrap:wrap;">
                        <span style="color:var(--text-dim);font-size:0.75rem;">Filter:</span>
                        <button class="timeline-filter active" data-type="all" onclick="filterTimeline('all')">All</button>
                        <button class="timeline-filter" data-type="legal" onclick="filterTimeline('legal')"><span class="legend-dot" style="background:var(--accent)"></span> Legal</button>
                        <button class="timeline-filter" data-type="death" onclick="filterTimeline('death')"><span class="legend-dot" style="background:var(--red)"></span> Death</button>
                        <button class="timeline-filter" data-type="arrest" onclick="filterTimeline('arrest')"><span class="legend-dot" style="background:var(--orange)"></span> Arrest</button>
                        <button class="timeline-filter" data-type="investigation" onclick="filterTimeline('investigation')"><span class="legend-dot" style="background:var(--purple)"></span> Investigation</button>
                        <button class="timeline-filter" data-type="media" onclick="filterTimeline('media')"><span class="legend-dot" style="background:var(--green)"></span> Media</button>
                        <button class="timeline-filter" data-type="custody" onclick="filterTimeline('custody')"><span class="legend-dot" style="background:var(--text-dim)"></span> Custody</button>
                        <button class="timeline-filter" data-type="event" onclick="filterTimeline('event')"><span class="legend-dot" style="background:#666"></span> Event</button>
                    </div>
                    <span id="timeline-count" style="color:var(--text-dim);font-size:0.75rem;margin-left:12px;"></span>
                    <span style="margin-left:auto;font-size:0.75rem;">Scroll to zoom • Drag to pan • Click event for details</span>
                </div>
            </div>

            <!-- Targets Tab -->
            <div id="tab-targets" class="content hidden">
                <div class="entity-list" id="targets-list">
                    <div class="loading">Loading targets...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div class="modal-title" id="modal-title"></div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script>
        const API = '/api/v2';
        let currentConvId = null;
        let isGenerating = false;

        // Load stats
        fetch(`${API}/stats`).then(r => r.json()).then(s => {
            document.getElementById('stat-docs').textContent = (s.documents || 0).toLocaleString();
            document.getElementById('stat-nodes').textContent = (s.nodes || 0).toLocaleString();
        }).catch(() => {});

        // Load conversations
        async function loadConversations() {
            try {
                const convs = await fetch(`${API}/chat/conversations`).then(r => r.json());
                const list = document.getElementById('conv-list');
                list.innerHTML = convs.slice(0, 10).map(c => `
                    <div class="conv-item ${c.id === currentConvId ? 'active' : ''}" onclick="loadConversation('${c.id}')">
                        ${escapeHtml(c.title || 'Untitled')}
                    </div>
                `).join('');
            } catch (e) {}
        }
        loadConversations();

        // Tab navigation
        function showTab(tab) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById('header-title').textContent = tab.charAt(0).toUpperCase() + tab.slice(1);

            if (tab === 'graph') loadGraph();
            if (tab === 'targets') loadTargets();
        }

        // New chat
        function newChat() {
            currentConvId = null;
            document.getElementById('chat-messages').innerHTML = `
                <div class="message assistant">
                    Welcome to the Epstein Investigation Platform. Ask me anything about the documents, emails, or entities in the archive.
                </div>
            `;
            loadConversations();
            showTab('chat');
        }

        // Load conversation
        async function loadConversation(convId) {
            currentConvId = convId;
            const messages = await fetch(`${API}/chat/${convId}/messages`).then(r => r.json());
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => `
                <div class="message ${m.role}">${formatMessage(m.content)}</div>
            `).join('');
            container.scrollTop = container.scrollHeight;
            loadConversations();
            showTab('chat');
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || isGenerating) return;

            isGenerating = true;
            document.getElementById('chat-send').disabled = true;
            input.value = '';

            const container = document.getElementById('chat-messages');

            // Add user message
            container.innerHTML += `<div class="message user">${escapeHtml(message)}</div>`;

            // Add status message
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message status';
            statusDiv.textContent = 'Thinking...';
            container.appendChild(statusDiv);
            container.scrollTop = container.scrollHeight;

            // Create assistant message div
            const assistantDiv = document.createElement('div');
            assistantDiv.className = 'message assistant';
            assistantDiv.style.display = 'none';

            let responseText = '';
            let sourceIds = [];

            try {
                const response = await fetch(`${API}/chat/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message, conversation_id: currentConvId})
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        try {
                            const data = JSON.parse(line.slice(6));

                            if (data.type === 'conv_id') {
                                currentConvId = data.id;
                            }
                            if (data.type === 'status') {
                                statusDiv.textContent = data.msg;
                            }
                            if (data.type === 'chunk') {
                                statusDiv.style.display = 'none';
                                assistantDiv.style.display = 'block';
                                if (!assistantDiv.parentNode) {
                                    container.appendChild(assistantDiv);
                                }
                                responseText += data.text;
                                assistantDiv.innerHTML = formatMessage(responseText);
                                container.scrollTop = container.scrollHeight;
                            }
                            if (data.type === 'sources') {
                                sourceIds = data.ids || [];
                            }
                            if (data.type === 'done') {
                                if (sourceIds.length > 0) {
                                    const uniqueIds = [...new Set(sourceIds)];
                                    const sourcesId = 'sources-' + Date.now();
                                    assistantDiv.innerHTML += `
                                        <div class="message-sources">
                                            <button class="sources-btn" onclick="toggleSources('${sourcesId}', this)">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                    <polyline points="14 2 14 8 20 8"></polyline>
                                                </svg>
                                                Voir les sources (${uniqueIds.length})
                                            </button>
                                            <div id="${sourcesId}" class="sources-list">
                                                ${uniqueIds.map(id => `
                                                    <div class="source-item" onclick="showSource(${id})">
                                                        <span class="source-id">#${id}</span>
                                                        <span class="source-type">Document</span>
                                                        <span>Cliquer pour voir</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        } catch (e) {}
                    }
                }

                statusDiv.remove();
                loadConversations();

            } catch (e) {
                statusDiv.textContent = 'Error: ' + e.message;
            }

            isGenerating = false;
            document.getElementById('chat-send').disabled = false;
        }

        // Format message (markdown)
        function formatMessage(text) {
            let html = escapeHtml(text);

            // Headers (must be at start of line)
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

            // Horizontal rule
            html = html.replace(/^---$/gm, '<hr>');

            // Blockquotes
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

            // Bold and italic
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Lists (simple)
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

            // Line breaks (but not after block elements)
            html = html.replace(/\n(?!<)/g, '<br>');
            html = html.replace(/<br>(<h2|<h3|<hr|<ul|<blockquote)/g, '$1');
            html = html.replace(/(<\/h2>|<\/h3>|<\/ul>|<\/blockquote>)<br>/g, '$1');

            return html;
        }

        // Enter to send
        document.getElementById('chat-input').onkeydown = e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // Search
        let searchEngine = 'pg'; // 'pg' or 'blood'

        function setSearchEngine(engine) {
            searchEngine = engine;
            document.getElementById('engine-pg').classList.toggle('active', engine === 'pg');
            document.getElementById('engine-blood').classList.toggle('active', engine === 'blood');
            document.getElementById('search-stats').textContent = '';
        }

        document.getElementById('search-input').onkeydown = e => {
            if (e.key === 'Enter') doSearch();
        };

        async function doSearch() {
            const q = document.getElementById('search-input').value.trim();
            if (!q) return;

            const results = document.getElementById('search-results');
            const stats = document.getElementById('search-stats');
            results.innerHTML = '<div class="loading">Searching...</div>';
            stats.textContent = '';

            const startTime = performance.now();

            try {
                let data, items;
                if (searchEngine === 'blood') {
                    // Use C++ Blood server
                    const resp = await fetch(`${API}/search/blood?q=${encodeURIComponent(q)}&limit=30`);
                    data = await resp.json();
                    items = data.results || [];
                } else {
                    // Use PostgreSQL
                    data = await fetch(`${API}/search?q=${encodeURIComponent(q)}&limit=30`).then(r => r.json());
                    items = data;
                }

                const elapsed = (performance.now() - startTime).toFixed(0);
                stats.textContent = `${items.length} results in ${elapsed}ms (${searchEngine === 'blood' ? 'Blood C++' : 'PostgreSQL'})`;

                if (!items.length) {
                    results.innerHTML = '<div class="loading">No results found</div>';
                    return;
                }

                results.innerHTML = items.map(r => {
                    const id = r.doc_id || r.id;
                    const type = r.doc_type || r.type || 'document';
                    const title = r.title || 'Untitled';
                    const snippet = r.snippet || '';
                    const score = r.score ? ` (${r.score.toFixed(2)})` : '';
                    return `
                    <div class="result" onclick="showSource(${id}, '${type}')">
                        <div class="result-header">
                            <span class="result-type ${type}">${type}${score}</span>
                            <span class="result-title">${escapeHtml(title)}</span>
                        </div>
                        <div class="result-snippet">${escapeHtml(snippet.substring(0, 250))}...</div>
                    </div>
                `}).join('');
            } catch (e) {
                results.innerHTML = '<div class="loading">Search error: ' + e.message + '</div>';
            }
        }

        // Network visualization
        let network = null;
        let networkData = null;
        let edgeTypesLoaded = false;
        let timeline = null;
        let timelineData = null;
        let timelineItems = null;
        let currentTimelineFilter = 'all';
        let currentMode = 'network';

        // Set graph mode (network or timeline)
        function setGraphMode(mode) {
            currentMode = mode;
            document.getElementById('mode-network').classList.toggle('active', mode === 'network');
            document.getElementById('mode-timeline').classList.toggle('active', mode === 'timeline');
            document.getElementById('network-container').classList.toggle('hidden', mode !== 'network');
            document.getElementById('timeline-container').classList.toggle('active', mode === 'timeline');
            document.getElementById('graph-info').style.display = mode === 'network' ? 'block' : 'none';
            document.getElementById('timeline-info').style.display = mode === 'timeline' ? 'flex' : 'none';

            // Hide network-specific controls in timeline mode
            document.getElementById('edge-type-filter').style.display = mode === 'network' ? 'block' : 'none';
            document.getElementById('quick-filters').style.display = mode === 'network' ? 'flex' : 'none';

            if (mode === 'timeline' && !timeline) {
                loadTimeline();
            }
        }

        // Load timeline data
        async function loadTimeline() {
            const container = document.getElementById('timeline-container');
            const info = document.getElementById('timeline-info');

            container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim)">Loading timeline...</div>';

            try {
                const response = await fetch(`${API}/graph/timeline?subject=epstein&limit=200`);
                const data = await response.json();

                if (!data.events || data.events.length === 0) {
                    container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-dim)">No timeline events found</div>';
                    return;
                }

                // Store data globally for filtering
                timelineData = data.events;

                // Convert events to vis-timeline format
                timelineItems = new vis.DataSet(data.events.map(evt => ({
                    id: evt.id,
                    content: evt.title,
                    start: evt.date,
                    className: evt.type,
                    eventType: evt.type,
                    title: `<strong>${evt.title}</strong><br>${evt.date}<br>${evt.description || ''}`
                })));

                // Create timeline
                container.innerHTML = '';
                const options = {
                    height: '100%',
                    min: new Date('2000-01-01'),
                    max: new Date('2025-12-31'),
                    start: new Date('2005-01-01'),
                    end: new Date('2024-01-01'),
                    zoomMin: 1000 * 60 * 60 * 24 * 30,     // 1 month
                    zoomMax: 1000 * 60 * 60 * 24 * 365 * 25, // 25 years
                    orientation: 'top',
                    showCurrentTime: false,
                    stack: true,
                    margin: { item: 10 }
                };

                timeline = new vis.Timeline(container, timelineItems, options);
                updateTimelineCount();

                // Handle click on timeline item
                timeline.on('select', function(properties) {
                    if (properties.items.length > 0) {
                        const itemId = properties.items[0];
                        const evt = data.events.find(e => e.id === itemId);
                        if (evt) {
                            showModal(evt.title, `
                                <p><strong>Date:</strong> ${evt.date}</p>
                                <p><strong>Type:</strong> ${evt.type}</p>
                                <p><strong>Description:</strong> ${evt.description || 'No description'}</p>
                            `);
                        }
                    }
                });

            } catch (e) {
                console.error('Failed to load timeline:', e);
                container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--red)">Failed to load timeline</div>';
            }
        }

        // Filter timeline by event type
        function filterTimeline(type) {
            if (!timelineData || !timelineItems) return;

            currentTimelineFilter = type;

            // Update button states
            document.querySelectorAll('.timeline-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // Filter items
            if (type === 'all') {
                // Show all items
                const allItems = timelineData.map(evt => ({
                    id: evt.id,
                    content: evt.title,
                    start: evt.date,
                    className: evt.type,
                    eventType: evt.type,
                    title: `<strong>${evt.title}</strong><br>${evt.date}<br>${evt.description || ''}`
                }));
                timelineItems.clear();
                timelineItems.add(allItems);
            } else {
                // Show only matching type
                const filtered = timelineData.filter(evt => evt.type === type).map(evt => ({
                    id: evt.id,
                    content: evt.title,
                    start: evt.date,
                    className: evt.type,
                    eventType: evt.type,
                    title: `<strong>${evt.title}</strong><br>${evt.date}<br>${evt.description || ''}`
                }));
                timelineItems.clear();
                timelineItems.add(filtered);
            }

            updateTimelineCount();
            timeline.fit();
        }

        // Update timeline count display
        function updateTimelineCount() {
            const count = timelineItems ? timelineItems.length : 0;
            const total = timelineData ? timelineData.length : 0;
            const countEl = document.getElementById('timeline-count');
            if (countEl) {
                if (currentTimelineFilter === 'all') {
                    countEl.textContent = `${total} events`;
                } else {
                    countEl.textContent = `${count} of ${total} events`;
                }
            }
        }

        // Load edge types for filter dropdown
        async function loadEdgeTypes() {
            if (edgeTypesLoaded) return;
            try {
                const types = await fetch(`${API}/graph/edge-types`).then(r => r.json());
                const select = document.getElementById('edge-type-filter');

                // Group types by category
                const categories = {
                    'Relations': ['associate_of', 'employed_by', 'worked_with', 'worked_for', 'assistant_of', 'client_of'],
                    'Legal': ['accuser_of', 'legal_counsel', 'prosecuted', 'legal_co_mention', 'legal_representation'],
                    'Travel': ['flew_with', 'associated_with_location'],
                    'Communication': ['emailed', 'email_co_mention', 'co_occurrence', 'mentioned_with'],
                    'Other': []
                };

                // Add grouped options
                for (const [category, typeList] of Object.entries(categories)) {
                    const group = document.createElement('optgroup');
                    group.label = category;

                    for (const t of types) {
                        if (typeList.includes(t.type) || (category === 'Other' && !Object.values(categories).flat().includes(t.type))) {
                            const opt = document.createElement('option');
                            opt.value = t.type;
                            opt.textContent = `${t.type.replace(/_/g, ' ')} (${t.count})`;
                            group.appendChild(opt);
                        }
                    }

                    if (group.children.length > 0) {
                        select.appendChild(group);
                    }
                }

                edgeTypesLoaded = true;
            } catch (e) {
                console.error('Failed to load edge types:', e);
            }
        }

        // Set edge filter and reload
        function setEdgeFilter(types) {
            document.getElementById('edge-type-filter').value = types.split(',')[0] || '';
            loadNetwork();
        }

        async function loadGraph() {
            // Load edge types and auto-load network when graph tab is shown
            await loadEdgeTypes();
            if (!network) {
                loadNetwork('Jeffrey Epstein');
            }
        }

        async function loadNetwork(centerNode = null) {
            const container = document.getElementById('network-container');
            const info = document.getElementById('graph-info');
            const searchInput = document.getElementById('graph-search');
            const edgeFilter = document.getElementById('edge-type-filter').value;

            // Use search input if no center specified
            if (!centerNode && searchInput.value.trim()) {
                centerNode = searchInput.value.trim();
            }

            info.textContent = 'Loading network...';

            try {
                let url = `${API}/graph/network?limit=150&depth=2`;
                if (centerNode) {
                    url += `&center=${encodeURIComponent(centerNode)}`;
                }
                if (edgeFilter) {
                    url += `&edge_types=${encodeURIComponent(edgeFilter)}`;
                }

                const data = await fetch(url).then(r => r.json());

                if (!data.nodes || data.nodes.length === 0) {
                    info.textContent = 'No nodes found. Try a different search.';
                    return;
                }

                networkData = data;

                // Create vis-network datasets
                const nodes = new vis.DataSet(data.nodes);
                const edges = new vis.DataSet(data.edges);

                // Network options
                const options = {
                    nodes: {
                        shape: 'dot',
                        borderWidth: 2,
                        shadow: true,
                        font: {
                            color: '#e5e5e5',
                            size: 12,
                            face: 'system-ui, sans-serif'
                        }
                    },
                    edges: {
                        width: 1,
                        smooth: {
                            type: 'continuous',
                            roundness: 0.5
                        },
                        font: {
                            size: 9,
                            color: '#666',
                            strokeWidth: 0,
                            align: 'middle'
                        },
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        }
                    },
                    physics: {
                        enabled: true,
                        solver: 'forceAtlas2Based',
                        forceAtlas2Based: {
                            gravitationalConstant: -50,
                            centralGravity: 0.01,
                            springLength: 100,
                            springConstant: 0.08,
                            damping: 0.4
                        },
                        stabilization: {
                            enabled: true,
                            iterations: 200,
                            updateInterval: 25
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 100,
                        hideEdgesOnDrag: true,
                        multiselect: true
                    },
                    layout: {
                        improvedLayout: true
                    }
                };

                // Destroy old network if exists
                if (network) {
                    network.destroy();
                }

                // Create new network
                network = new vis.Network(container, { nodes, edges }, options);

                // Event handlers
                network.on('click', function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const node = nodes.get(nodeId);
                        info.innerHTML = `<strong>${escapeHtml(node.label)}</strong> - ${node.title ? node.title.replace(/\n/g, ' | ') : 'No details'}`;
                    }
                });

                network.on('doubleClick', function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const node = nodes.get(nodeId);
                        // Reload network centered on this node
                        searchInput.value = node.label;
                        loadNetwork(node.label);
                    }
                });

                network.once('stabilizationIterationsDone', function() {
                    network.setOptions({ physics: { enabled: false } });
                });

                const filterInfo = edgeFilter ? ` | Filter: <strong>${edgeFilter.replace(/_/g, ' ')}</strong>` : '';
                info.innerHTML = `<strong>${data.nodes.length}</strong> nodes, <strong>${data.edges.length}</strong> edges${filterInfo}. ${centerNode ? `Centered on: ${escapeHtml(centerNode)}` : 'Top entities'}. Double-click to explore.`;

            } catch (e) {
                info.textContent = 'Failed to load network: ' + e.message;
            }
        }

        // Handle Enter key in graph search
        document.getElementById('graph-search').onkeydown = e => {
            if (e.key === 'Enter') loadNetwork();
        };

        // Handle edge type filter change
        document.getElementById('edge-type-filter').onchange = () => {
            if (network) loadNetwork();
        };

        // Export PNG
        function exportPNG() {
            if (!network) {
                alert('Load a network first');
                return;
            }
            const canvas = document.querySelector('#network-container canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'epstein-network-' + new Date().toISOString().slice(0,10) + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.getElementById('graph-info').innerHTML = '<strong>PNG exported!</strong>';
            }
        }

        // Export JSON
        function exportJSON() {
            if (!networkData) {
                alert('Load a network first');
                return;
            }
            const exportData = {
                exported: new Date().toISOString(),
                query: document.getElementById('graph-search').value || 'default',
                filter: document.getElementById('edge-type-filter').value || 'all',
                nodes: networkData.nodes,
                edges: networkData.edges,
                stats: {
                    nodeCount: networkData.nodes.length,
                    edgeCount: networkData.edges.length
                }
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.download = 'epstein-network-' + new Date().toISOString().slice(0,10) + '.json';
            link.href = URL.createObjectURL(blob);
            link.click();
            document.getElementById('graph-info').innerHTML = '<strong>JSON exported!</strong> ' + exportData.stats.nodeCount + ' nodes, ' + exportData.stats.edgeCount + ' edges';
        }

        // Load targets
        async function loadTargets() {
            const list = document.getElementById('targets-list');
            try {
                const targets = await fetch(`${API}/targets`).then(r => r.json());
                list.innerHTML = targets.map(t => `
                    <div class="entity-item" onclick="showNode(${t.id})">
                        <span class="entity-name">${escapeHtml(t.name)}</span>
                        <div class="entity-scores">
                            Relevance: ${(t.relevance || 0).toFixed(2)} | Confidence: ${(t.confidence || 0).toFixed(2)}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Toggle sources panel
        function toggleSources(id, btn) {
            const panel = document.getElementById(id);
            if (panel) {
                panel.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        // Show source modal
        async function showSource(id) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            modal.classList.add('active');
            title.textContent = 'Chargement...';
            body.textContent = '';

            try {
                // Try email first
                let res = await fetch(`${API}/email/${id}`);
                let data = await res.json();

                if (data.error || !data.body) {
                    // Try document
                    res = await fetch(`${API}/document/${id}`);
                    data = await res.json();
                }

                if (data.subject || data.body) {
                    // Email format
                    title.textContent = data.subject || 'Email';
                    body.innerHTML = `<div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border);font-size:0.85rem;color:var(--text-dim)">
                        <div><strong>De:</strong> ${escapeHtml(data.sender || 'Inconnu')}</div>
                        <div><strong>À:</strong> ${escapeHtml(data.to || 'Inconnu')}</div>
                        <div><strong>Date:</strong> ${escapeHtml(data.date || 'Inconnue')}</div>
                        <div><strong>ID:</strong> #${id}</div>
                    </div>
                    <div style="white-space:pre-wrap">${escapeHtml(data.body || 'Pas de contenu')}</div>`;
                } else if (data.filename || data.content) {
                    // Document format
                    title.textContent = data.filename || `Document #${id}`;
                    body.innerHTML = `<div style="margin-bottom:12px;font-size:0.85rem;color:var(--text-dim)">
                        <strong>ID:</strong> #${id}
                    </div>
                    <div style="white-space:pre-wrap">${escapeHtml(data.content || 'Pas de contenu')}</div>`;
                } else {
                    title.textContent = `Source #${id}`;
                    body.textContent = 'Contenu non disponible';
                }
            } catch (e) {
                title.textContent = 'Erreur';
                body.textContent = 'Impossible de charger: ' + e.message;
            }
        }

        // Show node modal
        async function showNode(id) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            modal.classList.add('active');
            title.textContent = 'Loading...';
            body.textContent = '';

            try {
                const data = await fetch(`${API}/nodes/${id}`).then(r => r.json());
                const node = data.node;
                const edges = data.edges || [];
                title.textContent = node.name;
                body.innerHTML = `<strong>Type:</strong> ${node.type}
<strong>Relevance:</strong> ${(node.relevance_score || 0).toFixed(2)}
<strong>Confidence:</strong> ${(node.confidence_score || 0).toFixed(2)}

<strong>Connections (${edges.length}):</strong>
${edges.slice(0, 20).map(e => `- ${e.from_name} --[${e.type}]--> ${e.to_name}`).join('\n')}`;
            } catch (e) {
                title.textContent = 'Error';
                body.textContent = 'Failed to load';
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        document.getElementById('modal').onclick = e => { if (e.target.id === 'modal') closeModal(); };
        document.onkeydown = e => { if (e.key === 'Escape') closeModal(); };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
    </script>
</body>
</html>
